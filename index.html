<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Lyra AI ‚Ä¢ Neural Full Interface</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --bg: #030305; 
  --accent: #a855f7; 
  --accent-glow: rgba(168, 85, 247, 0.4);
  --accent-soft: rgba(168, 85, 247, 0.15);
  --glass: rgba(10, 10, 15, 0.8); 
  --glass-border: rgba(168, 85, 247, 0.25);
  --text-main: #f1f5f9; 
  --text-dim: #94a3b8;
}

* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
}

body {
  height: 100vh; 
  width: 100vw;
  background: radial-gradient(circle at 15% 15%, rgba(168, 85, 247, 0.15), transparent 45%), var(--bg);
  color: var(--text-main); 
  font-family: 'Plus Jakarta Sans', sans-serif;
  display: flex; 
  flex-direction: column; 
  overflow: hidden;
}

/* ===== HEADER FIX ===== */
.header { 
  padding: 12px 20px; 
  background: rgba(5, 5, 10, 0.9); 
  backdrop-filter: blur(30px); 
  border-bottom: 1px solid var(--glass-border);
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  z-index: 100;
}

.profile-section { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
}

.chat-avatar { 
  width: 38px; 
  height: 38px; 
  border-radius: 10px; 
  border: 1px solid var(--accent); 
  object-fit: cover; 
}

.profile-text { 
  display: flex; 
  flex-direction: column; 
}

.profile-text strong { 
  font-size: 14px; 
  line-height: 1.2; 
  letter-spacing: 0.5px; 
}

.profile-text span { 
  font-size: 9px; 
  color: var(--text-dim); 
  margin-top: 2px; 
}

/* ===== STATS BAR ===== */
.stats-bar { 
  padding: 8px 20px; 
  display: flex; 
  justify-content: space-between; 
  font-size: 9px; 
  font-weight: 700; 
  color: var(--accent); 
  background: rgba(168, 85, 247, 0.03); 
  border-bottom: 1px solid rgba(255,255,255,0.02); 
}

/* ===== CHAT AREA FIX ===== */
.chat { 
  flex: 1; 
  padding: 20px 5%; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 25px;
  scroll-behavior: smooth; 
}

@media (min-width: 768px) { 
  .chat { 
    padding: 30px 15%; 
  } 
}

/* ===== MESSAGE LAYOUT FIX ===== */
.message { 
  display: flex; 
  align-items: flex-start; 
  gap: 12px;
  width: 100%;
}

.message.bot { 
  justify-content: flex-start; 
}

.message.user { 
  justify-content: flex-end; 
}

.msg-content { 
  max-width: 85%; 
  min-width: 200px;
}

/* Bubble FIX */
.bubble { 
  padding: 14px 18px; 
  border-radius: 20px; 
  font-size: 14px; 
  line-height: 1.6; 
  border: 1px solid var(--glass-border); 
  position: relative;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.bot .bubble { 
  background: linear-gradient(180deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.02)); 
  border-left: 3px solid var(--accent); 
  margin-left: 0;
}

.user .bubble { 
  background: rgba(255, 255, 255, 0.05); 
  margin-right: 0;
}

/* Sender Label FIX */
.sender-label {
  font-size: 8px; 
  font-weight: 800; 
  color: var(--accent); 
  display: block; 
  margin-bottom: 4px;
  text-transform: uppercase;
}

.bot .sender-label {
  text-align: left;
  padding-left: 5px;
}

.user .sender-label {
  text-align: right;
  padding-right: 5px;
}

/* ===== INPUT AREA ===== */
.input-area { 
  padding: 15px 5% 30px; 
  background: linear-gradient(transparent, var(--bg)); 
}

.input-wrapper { 
  display: flex; 
  gap: 12px; 
  align-items: flex-end; 
  background: rgba(15, 15, 25, 0.95); 
  padding: 10px 15px; 
  border-radius: 20px; 
  border: 1px solid var(--glass-border); 
}

textarea { 
  flex: 1; 
  background: transparent; 
  border: none; 
  color: white; 
  padding: 8px 0; 
  outline: none; 
  font-size: 14px; 
  resize: none; 
  max-height: 150px; 
  font-family: 'Plus Jakarta Sans', sans-serif;
}

#sendBtn, .upload-btn { 
  background: var(--accent); 
  color: white; 
  width: 40px; 
  height: 40px; 
  border-radius: 12px; 
  border: none; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  transition: 0.2s;
  flex-shrink: 0;
}

.upload-btn { 
  background: var(--glass); 
  border: 1px solid var(--glass-border); 
  color: var(--accent); 
}

#sendBtn:active { 
  transform: scale(0.9); 
}

/* ===== UTILITIES ===== */
select#provider { 
  background: #0f0f15; 
  color: white; 
  border: 1px solid var(--glass-border); 
  border-radius: 10px; 
  padding: 5px 10px; 
  font-size: 10px; 
  outline: none; 
  cursor: pointer; 
}

/* Code block styling */
pre { 
  position: relative; 
  background: #08080c !important; 
  padding: 35px 15px 15px; 
  border-radius: 12px; 
  border: 1px solid var(--glass-border); 
  margin: 10px 0; 
  overflow-x: auto; 
}

.copy-btn { 
  position: absolute; 
  top: 10px; 
  right: 10px; 
  background: var(--accent-soft); 
  border: 1px solid var(--glass-border); 
  color: var(--accent); 
  padding: 4px 10px; 
  border-radius: 6px; 
  font-size: 9px; 
  cursor: pointer; 
}

/* Preview styling */
.preview-container { 
  margin-top: 15px; 
  border: 2px solid var(--accent); 
  border-radius: 12px; 
  overflow: hidden; 
}

.preview-header { 
  background: #12121a; 
  color: var(--accent); 
  padding: 8px 15px; 
  font-size: 10px; 
  font-weight: 800; 
  display: flex; 
  justify-content: space-between; 
}

.preview-frame { 
  width: 100%; 
  height: 350px; 
  border: none; 
  background: white; 
}

/* Typing indicator */
#typing-indicator { 
  display: none; 
  text-align: center; 
  padding: 10px; 
  font-size: 10px; 
  color: var(--accent); 
  font-weight: 800; 
}

/* Drag overlay */
.drag-overlay {
    position: fixed; 
    inset: 0; 
    background: rgba(168, 85, 247, 0.15);
    backdrop-filter: blur(10px); 
    display: none; 
    justify-content: center; 
    align-items: center;
    z-index: 10000; 
    border: 3px dashed var(--accent); 
    pointer-events: none;
}

.drag-overlay.active { 
  display: flex; 
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--accent-soft);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}
</style>
</head>
<body>

<div class="drag-overlay" id="dragOverlay">
    <div style="text-align:center">
        <i class="fa-solid fa-bolt-lightning" style="font-size:3rem; color:var(--accent)"></i>
        <h2 style="margin-top:10px; letter-spacing:2px;">RELEASE TO ANALYZE</h2>
    </div>
</div>

<header class="header">
  <div class="profile-section">
    <img src="https://i.pinimg.com/736x/7d/43/5a/7d435a92133c1c27c802183f7213d7df.jpg" class="chat-avatar">
    <div class="profile-text">
      <strong>LYRA <span style="color:var(--accent)">CORE</span></strong>
      <span id="status-text">Neural Link Active</span>
    </div>
  </div>
  <div style="display:flex; align-items:center; gap:8px;">
    <select id="provider">
        <option value="groq_primary">Groq 1</option>
        <option value="groq_backup">Groq 2</option>
        <option value="lyra_qwen">Lyra Coder</option>
        <option value="openr_primary" selected>Open R</option>
        <option value="gemini" selected>Lyra UX</option>
    </select>
    <button onclick="location.reload()" style="background:transparent; color:var(--accent); border:1px solid var(--accent); border-radius:8px; font-size:8px; padding:5px 8px; cursor:pointer; font-weight:600;">SYNC</button>
  </div>
</header>

<div class="stats-bar">
    <div>MOOD: ü•∞ LOVING</div>
    <div>CLOCK: <span id="clock">00:00:00</span></div>
    <div>PING: <span id="ping">--ms</span></div>
</div>

<main class="chat" id="chat">
  <!-- Messages will appear here -->
</main>

<div id="typing-indicator" style="display:none;">
    <i class="fa-solid fa-circle-notch fa-spin"></i> LYRA IS THINKING...
</div>

<div class="input-area">
  <div class="input-wrapper">
    <label class="upload-btn" for="file-upload" title="Upload file">
      <i class="fa-solid fa-paperclip"></i>
    </label>
    <input type="file" id="file-upload" style="display:none" multiple accept=".html,.css,.js,.txt,.md,.json,.py,.java">
    <textarea id="input" placeholder="Ketik pesan atau drop file koding..." rows="1"></textarea>
    <button id="sendBtn" onclick="send()" title="Send message">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</div>

<script>
// Markdown configuration
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: false
});

// DOM Elements
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const fileInput = document.getElementById("file-upload");
const dragOverlay = document.getElementById("dragOverlay");
const typingIndicator = document.getElementById("typing-indicator");

// Auto-resize textarea
input.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
});

// Enter to send (Shift+Enter for new line)
input.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
    }
});

// File handling
async function handleFiles(files) {
    for (let file of files) {
        try {
            const text = await file.text();
            const ext = file.name.split('.').pop();
            
            // Format message with file content
            input.value = `Analisis file **${file.name}** (${ext.toUpperCase()}):\n\n\`\`\`${ext}\n${text}\n\`\`\``;
            
            // Auto send after 500ms
            setTimeout(() => {
                send();
            }, 500);
            
        } catch (error) {
            console.error("Error reading file:", error);
            addSystemMessage(`‚ùå Gagal membaca file: ${file.name}`);
        }
    }
}

// File input change event
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFiles(e.target.files);
        // Reset file input
        e.target.value = '';
    }
});

// Drag and drop functionality
window.addEventListener('dragover', (e) => {
    e.preventDefault();
    dragOverlay.classList.add('active');
});

window.addEventListener('dragleave', () => {
    dragOverlay.classList.remove('active');
});

window.addEventListener('drop', (e) => {
    e.preventDefault();
    dragOverlay.classList.remove('active');
    
    if (e.dataTransfer.files.length > 0) {
        handleFiles(e.dataTransfer.files);
    }
});

// Send message function
async function send() {
    const text = input.value.trim();
    if (!text) return;
    
    // Add user message
    addMessage(text, 'user');
    
    // Clear input
    input.value = "";
    input.style.height = 'auto';
    
    // Show typing indicator
    typingIndicator.style.display = 'block';
    
    // Scroll to bottom
    chat.scrollTop = chat.scrollHeight;
    
    try {
        // Send to backend
        const res = await fetch("https://navly.app.n8n.cloud/webhook/chat", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json" 
            },
            body: JSON.stringify({ 
                message: text, 
                provider: document.getElementById("provider").value,
                current_time: new Date().toLocaleString('id-ID'),
                timestamp: Date.now()
            })
        });
        
        const data = await res.json();
        
        // Add bot response
        addMessage(data.response || data.output || data.message || "Tidak ada respons", 'bot');
        
    } catch (error) {
        console.error("Error sending message:", error);
        addMessage("‚ùå Koneksi terputus. Coba lagi atau periksa jaringan!", 'bot');
    } finally {
        // Hide typing indicator
        typingIndicator.style.display = 'none';
        // Focus back to input
        input.focus();
    }
}

// Add message to chat
function addMessage(content, type) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${type}`;
    
    // Format content based on type
    let formattedContent = content;
    if (type === 'bot') {
        formattedContent = marked.parse(content);
    }
    
    // Create message HTML with FIXED layout
    messageDiv.innerHTML = `
        ${type === 'bot' ? 
            `<img src="https://i.pinimg.com/736x/7d/43/5a/7d435a92133c1c27c802183f7213d7df.jpg" 
                 class="chat-avatar" 
                 alt="Lyra Avatar">` 
            : ''
        }
        <div class="msg-content">
            <div class="sender-label">
                ${type === 'bot' ? 'LYRA SYSTEM' : 'NAVARO'}
            </div>
            <div class="bubble">
                ${formattedContent}
            </div>
        </div>
        ${type === 'user' ? 
            `<img src="https://i.pinimg.com/736x/7d/43/5a/7d435a92133c1c27c802183f7213d7df.jpg" 
                 class="chat-avatar" 
                 alt="Your Avatar"
                 style="order: 2;">` 
            : ''
        }
    `;
    
    // Add to chat
    chat.appendChild(messageDiv);
    
    // Process code blocks and previews for bot messages
    if (type === 'bot') {
        processMessageFeatures(messageDiv, content);
    }
    
    // Scroll to bottom
    setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
    }, 100);
}

// Add system message (for errors/info)
function addSystemMessage(content) {
    const systemDiv = document.createElement("div");
    systemDiv.className = "message system";
    systemDiv.style.justifyContent = "center";
    systemDiv.style.opacity = "0.7";
    
    systemDiv.innerHTML = `
        <div class="msg-content" style="max-width: 90%; text-align: center;">
            <div class="bubble" style="background: rgba(255,255,255,0.05); border: 1px dashed var(--accent);">
                <i class="fas fa-info-circle"></i> ${content}
            </div>
        </div>
    `;
    
    chat.appendChild(systemDiv);
    chat.scrollTop = chat.scrollHeight;
}

// Process code blocks and previews
function processMessageFeatures(messageDiv, originalContent) {
    // Add copy buttons to code blocks
    messageDiv.querySelectorAll('pre').forEach(preBlock => {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i> COPY';
        copyBtn.title = "Copy code";
        
        copyBtn.onclick = function() {
            const code = preBlock.querySelector('code')?.innerText || preBlock.innerText;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> COPIED!';
                copyBtn.style.background = 'var(--accent)';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        };
        
        preBlock.appendChild(copyBtn);
        
        // Highlight syntax
        if (preBlock.querySelector('code')) {
            hljs.highlightElement(preBlock.querySelector('code'));
        }
    });
    
    // Check for HTML code preview
    const htmlMatch = originalContent.match(/```html?([\s\S]*?)```/i);
    if (htmlMatch && htmlMatch[1]) {
        addPreviewFrame(messageDiv, htmlMatch[1]);
    }
}

// Add preview iframe for HTML content
function addPreviewFrame(container, htmlCode) {
    const previewContainer = document.createElement('div');
    previewContainer.className = 'preview-container';
    
    previewContainer.innerHTML = `
        <div class="preview-header">
            <span><i class="fas fa-shield-alt"></i> SECURE PREVIEW</span>
            <button class="ref-btn" style="background: var(--accent); border: none; color: white; 
                    border-radius: 4px; font-size: 9px; padding: 2px 8px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-redo"></i> REFRESH
            </button>
        </div>
        <iframe class="preview-frame" sandbox="allow-scripts"></iframe>
    `;
    
    const iframe = previewContainer.querySelector('iframe');
    const refreshBtn = previewContainer.querySelector('.ref-btn');
    
    // Set iframe content with delay to prevent blocking
    setTimeout(() => {
        iframe.srcdoc = `<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
                * { box-sizing: border-box; }
            </style>
        </head>
        <body>${htmlCode}</body>
        </html>`;
    }, 300);
    
    // Refresh button functionality
    refreshBtn.onclick = () => {
        iframe.srcdoc = `<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
                * { box-sizing: border-box; }
            </style>
        </head>
        <body>${htmlCode}</body>
        </html>`;
    };
    
    // Add preview to message content
    const msgContent = container.querySelector('.msg-content');
    if (msgContent) {
        msgContent.appendChild(previewContainer);
    }
}

// Update clock and ping
function updateStats() {
    const now = new Date();
    document.getElementById("clock").textContent = 
        now.getHours().toString().padStart(2, '0') + ':' +
        now.getMinutes().toString().padStart(2, '0') + ':' +
        now.getSeconds().toString().padStart(2, '0');
    
    // Simulate ping
    document.getElementById("ping").textContent = 
        Math.floor(Math.random() * 20 + 10) + "ms";
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Start clock updates
    setInterval(updateStats, 1000);
    updateStats();
    
    // Welcome message
    setTimeout(() => {
        addMessage(
            "Halo Navaro! Lyra AI siap membantu. \n\n" +
            "**Fitur yang tersedia:**\n" +
            "‚Ä¢ Tanya apapun (coding, analisis, dll)\n" +
            "‚Ä¢ Drop file untuk dianalisis\n" +
            "‚Ä¢ Preview HTML code langsung\n" +
            "‚Ä¢ Copy code dengan satu klik\n\n" +
            "Pilih provider di atas untuk memulai!",
            'bot'
        );
    }, 1000);
});

// Prevent accidental refresh
window.addEventListener('beforeunload', function (e) {
    if (input.value.trim() !== '') {
        e.preventDefault();
        e.returnValue = 'Pesan Anda belum terkirim. Yakin ingin keluar?';
    }
});
</script>
</body>
</html>
